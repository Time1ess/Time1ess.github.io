---
title: DDIA读书笔记2-可靠性、可扩展性和可维护性(二)
tags: [系统架构,读书笔记,技术选型]
categories: 系统架构
---

前文讲述了数据系统与可靠性，本篇中将对可扩展性以及可维护性进行总结。

<!-- more -->

# 可扩展性

即使一个系统在当下可靠的运行，并不代表在未来也会可靠运行。一个常见的原因是负载的增加：或许系统从支持10k的并发用户增加到了支持100k的并发用户，或者从1m增加到了10m。或许系统处理了比之前更多的数据量。

可扩展性是一个我们用来描述系统应对负载增长能力的术语。但需要注意的是，这并不是我们直接赋予系统的一个一维的标签:说“X可扩展”或者是“Y不可扩展”毫无意义。而应该是，“如果一个系统在某种程度上增长了，我们有哪些选项来应对这种增长？”和“我们如何增加更多的计算资源来应对额外的负载？”

## 描述负载

首先我们需要简要的描述当前系统的负载，之后才能讨论增长的问题。负载可以通过几个我们称之为负载参数的数字来进行描述。对于参数的最好选择依赖于系统架构：可能是网络服务器的每秒请求数，数据库的读写比，聊天室的并发活跃用户数，缓存命中率等等。或许平均情况下是你最在意哪个或者你的瓶颈来自于小部分极端案例。

为了更具体的描述，我们考虑Twitter，Twitter的两个主要操作是:

* 发布推文：每个用户能够发送新的信息给所有关注他的人(平均4.6k请求每秒，峰值12k请求每秒)
* 主页时间线：用户可以浏览他关注的人的所有推文(300k请求每秒)

单纯处理12k每秒的写是十分简单的。但是，Twitter的扩展挑战并不主要来自于推文的容量，而是扇出(**fan-out**)——每个用户关注了许多用户，每个用户被许多用户关注。有两种方式来实现以上操作：

1. 发布一条推文只是简单的向推文集合里面插入一条新的推文。当一个用户请求的主页时间线时，查找所有其关注的用户，以及这些用户发布的推文，然后聚合这些推文(以时间排序)。在一个关系型数据库中，你可以写出以下语句：
	![](twitter_sql.png)
2. 为每个用户的主页时间线维护一个缓存——就像为每个用户提供一个推文的收件邮箱。当一个用户发布一个推文，查找所有关注该用户的用户，将该新推文插入到他们的主页时间线中。对主页时间线的请求将变得轻量，因为它的结果已经提前被计算好的。

Twitter最开始使用的是方法1，但是系统无法跟上主页时间线请求负载的增加，因此它们转向了方法2.其表现更好的原因是发布推文的平均频率几乎小于请求主页时间线平均频率两个数量级，因此在本案例中在写入的时候做更多的工作优于在读的时候做更多的工作。

然而，方法2存在的一个弊端是发布一个推文需要更多的额外工作。平均情况下，一条推文将会发送给大约75个关注这，因此4.6k每秒的推特发布速度变成了345k每秒的主页时间线缓存写入。但是这样的平均下隐藏了一个事实，那就是每个用户的关注者数量差别巨大，有些用户拥有超过30m的关注者。者代表着一条推文可能导致超过30m的主页时间线写入！而完成这项操作是十分耗时的——Twitter试图将推文的投递给所有关注者这一操作限制到5秒以内——这是一个巨大的挑战。

最终Twitter采用的版本是两种方法的混合。大多数用户的推文保持在发布是写入到关注者的主页时间线中，少部分拥有大量关注者的用户不采用扇出的方式。用户在访问主页时间线时其关注的名人的推文将单独获取并合并到用户的主页时间线中，就像方法1一样。