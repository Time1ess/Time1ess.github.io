---
title: 海量数据判重之布隆过滤器
tags:
  - 系统设计
  - 爬虫
  - 哈希
category: 系统设计
date: 2018-05-07 10:57:07
categories:
---


查询一个对象是否存在于一个集合中，在很多任务中都是十分重要的一部分，常见的使用场景主要是海量数据的判重等。布隆过滤器(Bloom Filter)便是解决此类问题的理想工具之一。

<!-- more -->

我们知道，可以使用哈希表来完成O(1)时间查询一个对象是否存在于一个集合中，但是传统的哈希虽然时间效率很高，但是因为采用开放寻址法来接触哈希冲突，因此为了保证查询时间效率，所以空间效率较低，一般只能达到不到50%，假设我们有N=10,000,000条数据需要进行判重的话，那么整个空间消耗是比较大的，更不用说在日常海量数据情况下的表现了，而布隆过滤器就是一个在容忍一定假正率的情况下，时间复杂度达到O(1)，空间效率很高的一个判重工具。

# 插入原理

布隆过滤器的插入原理跟普通的哈希过程很相似，不同与普通的哈希算法只使用一个哈希函数，布隆过滤器使用了多个**互不相关**的哈希函数来完成哈希过程，如下图所示。

![](bloom_filter.png)

对于任一元素，我们使用了K（此处K=3）个哈希函数来分别其哈希值，然后将该哈希值对M（此处m=24，布隆过滤器容量大小）取模，得到3个位置，然后将该位置置为1，需要注意的是，布隆过滤器每个位置只需要判断`True`或者`False`，因此只需要一个bit即可表示，因此最后该元素对应的3个位置将被置为`True`。

# 查找原理

要判断一个元素是否已经存在，这一过程跟插入很相似，也是计算出多个位置，只有当这些位置都为`0b1`的时候，那么该元素才已经存在，否则该元素不存在，如下图所示。

![](bloom_filter_lookup.png)

对于x，因为x已经在之前将其对应的三个位置设置为了`True`，因此在本次查找中可以发现其对应的位置全部为`True`，因此该元素存在。对于z，我们发现其有两个位置不为`True`，因此该元素肯定不存在。

# 伪码描述

我们可以使用伪码来描述插入与查找过程。

## 插入

```
# x: Target value
# m: Capacity
# bits: Bloom filter bits storage
# hash_funcs: Distinct hash functions

def insert(x):
    for hash_func in hash_funcs:
        p = hash_func(x) % m
        bits[p] = True
```
## 查找

```
def lookup(x):
    found = True
    for hash_func in hash_funcs:
        p = hash_func(x) % m
        found = found && bits[p]
    return found
```

# 错误率

![](bloom_filter_error.png)

细心的读者可能已经发现了，在前文查找z的时候，我们有一个哈希函数结果对应的位置是元素y的某个位置，那么在极端情况下，可能一个从来没有见过的元素被误认为已经见过了，如上图中的h，其对应的K个位置都被其他元素设置成了`True`，这是我们通常所说的`False Positive`，即假正，那么其对应的概率即假正率到底有多大呢？我们可以通过概率的知识来进行定量的计算。

**已知**：总共有m个bit，k个哈希函数（哈希函数插入每个位置概率相等），已经插入n个元素
**求**：对一个新元素，其被错误识别为已插入的概率

插入第一个元素时，一个哈希函数将某一位设置成`True`的概率是

$$ \frac{1}{m} $$

那么该位不被设置成`True`的概率是

$$ 1 - \frac{1}{m} $$

在插入k个哈希位置之后，即完成一个元素的插入之后，该位不被设置成`True`的概率是

$$ {(1 - \frac{1}{m})}^k $$

在完成n个元素的插入之后，该位不被设置成`True`的概率是

$$ {(1 - \frac{1}{m})}^{nk} $$

那么该位被设置成`True`的概率是

$$ 1 - {(1 - \frac{1}{m})}^{nk} $$

对一个新的元素，其被错误识别为已存在可以等价于其k个位置都被设置为了`True`，其概率为

$$ \varepsilon \approx {(1 - {(1 - \frac{1}{m})}^{nk})}^k $$

我们通过极限公式

$$ \lim\limits_{n\to\infty}{(1+\dfrac {1}{n})^n} = e $$

将其转化为

$$ \varepsilon \approx {(1 - {(1 - e^{-\frac{nk}{m}})})}^k $$

我们根据以上公式可以发现，最后假正率跟n/m和k有关，基于此，我们可以使用不同组合来计算假正率，结果如下表所示。

|m/n|K = 1|K = 2|K = 3|K = 4|K = 5|K = 6|K = 7|K = 8|K = 9|K = 10|K = 11|K = 12|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|2|0.3934693|0.3995764|0.4688617|0.5589732|0.6516469|0.7360810|0.8068326|0.8625315|0.9043485|0.9346272|0.9559529|0.9706572|
|3|0.2834687|0.2367629|0.2525805|0.2940775|0.3511052|0.4179135|0.4896758|0.5620731|0.6315219|0.6954066|0.7521399|0.8010552|
|4|0.2211992|0.1548181|0.1468916|0.1596613|0.1849078|0.2198313|0.2628405|0.3124510|0.3669978|0.4246437|0.4835067|0.5418153|
|5|0.1812692|0.1086889|0.0918488|0.0919536|0.1009252|0.1164499|0.1377817|0.1646166|0.1966885|0.2336024|0.2747749|0.3194357|
|6|0.1535183|0.0803545|0.0609162|0.0560567|0.0577811|0.0637969|0.0734099|0.0864816|0.1030705|0.1232749|0.1471486|0.1746517|
|7|0.1331221|0.0617635|0.0423483|0.0358990|0.0346578|0.0363787|0.0403273|0.0463077|0.0543501|0.0645847|0.0771784|0.0922953|
|8|0.1175031|0.0489291|0.0305794|0.0239687|0.0216792|0.0215771|0.0229297|0.0254917|0.0292244|0.0341909|0.0405091|0.0483258|
|9|0.1051607|0.0397056|0.0227780|0.0165770|0.0140703|0.0132721|0.0134892|0.0144631|0.0161138|0.0184491|0.0215259|0.0254323|
|10|0.0951626|0.0328585|0.0174106|0.0118133|0.0094309|0.0084362|0.0081937|0.0084555|0.0091270|0.0101859|0.0116495|0.0135606|
|11|0.0868993|0.0276381|0.0136005|0.0086373|0.0065018|0.0055222|0.0051259|0.0050864|0.0053098|0.0057616|0.0064387|0.0073573|
|12|0.0799556|0.0235679|0.0108231|0.0064568|0.0045945|0.0037108|0.0032939|0.0031424|0.0031695|0.0033387|0.0036380|0.0040700|
|13|0.0740389|0.0203336|0.0087517|0.0049210|0.0033183|0.0025527|0.0021689|0.0019897|0.0019384|0.0019804|0.0021013|0.0022975|
|14|0.0689372|0.0177215|0.0071759|0.0038147|0.0024433|0.0017934|0.0014601|0.0012887|0.0012127|0.0012012|0.0012399|0.0013234|
|15|0.0644930|0.0155817|0.0059562|0.0030019|0.0018303|0.0012840|0.0010028|0.0008523|0.0007749|0.0007440|0.0007468|0.0007775|
|16|0.0605869|0.0138070|0.0049977|0.0023941|0.0013925|0.0009351|0.0007015|0.0005745|0.0005049|0.0004700|0.0004587|0.0004656|
|17|0.0571269|0.0123188|0.0042340|0.0019323|0.0010742|0.0006916|0.0004990|0.0003941|0.0003350|0.0003024|0.0002870|0.0002839|
|18|0.0540405|0.0110588|0.0036181|0.0015765|0.0008392|0.0005188|0.0003604|0.0002748|0.0002260|0.0001980|0.0001827|0.0001761|
|19|0.0512705|0.0099825|0.0031160|0.0012989|0.0006632|0.0003942|0.0002640|0.0001945|0.0001549|0.0001317|0.0001182|0.0001111|
|20|0.0487706|0.0090559|0.0027026|0.0010797|0.0005296|0.0003031|0.0001959|0.0001396|0.0001077|0.0000889|0.0000777|0.0000712|
|21|0.0465030|0.0082526|0.0023591|0.0009048|0.0004269|0.0002356|0.0001471|0.0001014|0.0000759|0.0000609|0.0000518|0.0000463|
|22|0.0444370|0.0075515|0.0020714|0.0007639|0.0003473|0.0001850|0.0001117|0.0000746|0.0000542|0.0000423|0.0000350|0.0000305|
|23|0.0425466|0.0069361|0.0018287|0.0006493|0.0002847|0.0001466|0.0000856|0.0000555|0.0000392|0.0000297|0.0000240|0.0000204|
|24|0.0408105|0.0063929|0.0016224|0.0005554|0.0002352|0.0001171|0.0000663|0.0000417|0.0000286|0.0000211|0.0000166|0.0000138|
|25|0.0392106|0.0059111|0.0014459|0.0004779|0.0001957|0.0000944|0.0000518|0.0000316|0.0000211|0.0000152|0.0000116|0.0000094|
|26|0.0377313|0.0054818|0.0012942|0.0004135|0.0001639|0.0000766|0.0000408|0.0000242|0.0000157|0.0000110|0.0000082|0.0000065|
|27|0.0363596|0.0050975|0.0011629|0.0003595|0.0001381|0.0000626|0.0000324|0.0000187|0.0000118|0.0000081|0.0000059|0.0000046|
|28|0.0350841|0.0047523|0.0010489|0.0003141|0.0001170|0.0000515|0.0000259|0.0000146|0.0000090|0.0000060|0.0000043|0.0000032|
|29|0.0338950|0.0044410|0.0009492|0.0002756|0.0000996|0.0000426|0.0000209|0.0000114|0.0000069|0.0000045|0.0000031|0.0000023|
|30|0.0327839|0.0041593|0.0008618|0.0002428|0.0000853|0.0000355|0.0000169|0.0000090|0.0000053|0.0000034|0.0000023|0.0000016|
|31|0.0317433|0.0039036|0.0007848|0.0002147|0.0000733|0.0000297|0.0000138|0.0000072|0.0000041|0.0000025|0.0000017|0.0000012|
|32|0.0307668|0.0036708|0.0007167|0.0001906|0.0000633|0.0000250|0.0000113|0.0000057|0.0000032|0.0000019|0.0000013|0.0000009|

画图可以看出变化曲线，如下图。

![](error_rate_fig.png)

通过上表，我们来计算本文开头的那个问题，假设我们有N=10,000,000个元素，容忍<0.0001的错误率，大概需要多大的空间，通过查表，我们知道当m/n=20，k=10时，错误率大概在0.0000889，满足条件，其空间消耗为**190.73MB**。

上面我们选取的m/n的值和k的值是比较随意的，那么k的个数是否存在最优解呢？答案是**Yes**。

在这里不再进行推导，k的最优值大致为

$$ k=\frac{m}{n} \ln2\approx 0.7\frac{m}{n} $$

因此对应上面问题其最优k值应该为**14**。

# 总结

布隆过滤器通过引入一定的错误率以及同时使用多个哈希函数，大大提高了空间使用效率，这使得在海量数据中进行判重更加高效。但是标准的布隆过滤器只支持添加而不支持删除，因此也有相关研究提出了可计数型布隆过滤器(Counting Bloom Filter)，在此不进行讨论。